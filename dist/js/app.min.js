window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var Fluid=function(){this.ctx=null,this.width=0,this.height=0,this.num_x=0,this.num_y=0,this.particles=null,this.grid=null,this.meta_ctx=null,this.context=this,this.threshold=220,this.play=!1,this.spacing=45,this.limit=.66*element.radius,this.num_particles=0};Fluid.prototype.process_image=function(){for(var t=this,i=t.meta_ctx.getImageData(0,0,t.width,t.height),e=i.data,s=0,n=e.length;s<n;s+=4)e[s+3]<t.threshold&&(e[s+3]/=6);t.ctx.putImageData(i,0,0)},Fluid.prototype.addParticle=function(t,i,e,s,n){var r=this;r.particles.push(new Particle(t,i,e,s,n)),r.num_particles=r.particles.length},Fluid.prototype.destroyParticle=function(t){var i=this;i.particles.splice(i.particles.indexOf(t),1),i.num_particles=i.particles.length},Fluid.prototype.run=function(){var t=fluid.context;t.meta_ctx.clearRect(0,0,t.width,t.height);for(var i=0,e=t.num_x*t.num_y;i<e;i++)t.grid[i].length=0;i=t.num_particles;if(!settings.pauseOnDrawing&&mouse.mouseDrawing||!mouse.mouseDrawing)for(;i--;)t.particles[i]&&t.particles[i].first_process();for(i=t.num_particles;i--;)t.particles[i]&&t.particles[i].second_process();fluid.process_image(),settings.inflow&&fluid.addParticle(type.water.id,fluid.limit,fluid.limit,fluid.limit-4),mouse.down?mouse.process():(mouse.previousX=mouse.x,mouse.previousY=mouse.y),t.play&&!settings.pauseGame&&requestAnimFrame(fluid.run)},Fluid.prototype.init=function(t,i,e){var s=this;s.particles=[],s.grid=[];var t=document.getElementById(t);s.ctx=t.getContext("2d"),t.height=e||window.innerHeight,t.width=i||window.innerWidth,s.width=t.width,s.height=t.height;var n=document.createElement("canvas");n.width=s.width,n.height=s.height,s.meta_ctx=n.getContext("2d"),element.createElement(type.water),s.num_x=Math.round(s.width/s.spacing)+1,s.num_y=Math.round(s.height/s.spacing)+1;for(r=0;r<s.num_x*s.num_y;r++)s.grid[r]={length:0,close:[]};for(var r=0;r<settings.GROUPS.length;r++)for(var u=0;u<settings.GROUPS[r];u++)s.particles.push(new Particle(r,element.radius+Math.random()*(s.width-2*element.radius),element.radius+Math.random()*(s.height-2*element.radius)));s.num_particles=s.particles.length,s.play=!0,fluid.initEvents(t),fluid.run(this)},Fluid.prototype.initEvents=function(t){t.onmousedown=function(t){return mouse.down=!0,mouse.mouseDrawing=!0,!1},document.onmouseup=function(t){return mouse.down=!1,mouse.mouseDrawing=!1,mouse.previousX=0,mouse.previousY=0,!1},t.onmousemove=function(i){var e=t.getBoundingClientRect();return mouse.x=i.clientX-e.left,mouse.y=i.clientY-e.top,!1},t.onmouseout=function(t){mouse.outXposition=t.pageX-this.offsetLeft,mouse.outYposition=t.pageY-this.offsetTop,mouse.out=!0},t.onmouseover=function(t){mouse.out=!1}},Fluid.prototype.stop=function(){this.play=!1},Fluid.prototype.resume=function(){this.run()};var fluid=new Fluid,Element=function(){};Element.prototype.init=function(){this.textures=[],this.radius=30,this.newElement=[]},Element.prototype.createElement=function(t){settings.elementTypeId=t.id;var i=t.color;this.newElement=document.createElement("canvas"),this.newElement.width=2*this.radius,this.newElement.height=2*this.radius,this.textures[t.id]=this.newElement;var e=this.textures[t.id].getContext("2d"),s=e.createRadialGradient(this.radius,this.radius,1,this.radius,this.radius,this.radius);s.addColorStop(0,i+",1)"),s.addColorStop(1,i+",0)"),e.fillStyle=s,e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,2*Math.PI,!0),e.closePath(),e.fill()};var element=new Element;element.init();var Events=function(){};Events.prototype.init=function(){document.getElementById("pauseOnDrawing").getElementsByTagName("input")[0].onclick=function(t){settings.pauseOnDrawing=!settings.pauseOnDrawing},document.getElementById("pauseGame").getElementsByTagName("input")[0].onclick=function(t){settings.pauseGame=!settings.pauseGame,settings.pauseGame||fluid.resume()},document.getElementById("outflow").getElementsByTagName("input")[0].onclick=function(t){settings.outflow=!settings.outflow},document.getElementById("inflow").getElementsByTagName("input")[0].onclick=function(t){settings.inflow=!settings.inflow},document.getElementById("water-button").onclick=function(t){events.removeActive(),this.classList.add("active"),element.createElement(type.water)},document.getElementById("fire-button").onclick=function(t){events.removeActive(),this.classList.add("active"),element.createElement(type.fire)},document.getElementById("wall-button").onclick=function(t){events.removeActive(),this.classList.add("active"),element.createElement(type.wall)}},Events.prototype.removeActive=function(){for(var t=document.getElementsByClassName("active"),i=0;i<t.length;i++)t[i].classList.remove("active")};var events=new Events;events.init();var Mouse=function(){};Mouse.prototype.init=function(){this.down=!1,this.out=!1,this.x=0,this.y=0,this.mouseDrawing=!1,this.xDiff=0,this.yDiff=0,this.increaseValueX=0,this.increaseValueY=0,this.currentX=0,this.currentY=0,this.finalX=0,this.finalY=0,this.previousX=0,this.previousY=0,this.outXposition=0,this.outYposition=0},Mouse.prototype.process=function(){if(this.currentX=this.x,this.currentY=this.y,this.previousX>this.currentX&&(this.xDiff=this.previousX-this.currentX,this.increaseValueX=!1),this.previousX<this.currentX&&(this.xDiff=this.currentX-this.previousX,this.increaseValueX=!0),this.previousY>this.currentY&&(this.yDiff=this.previousY-this.currentY,this.increaseValueY=!1),this.previousY<this.currentY&&(this.yDiff=this.currentY-this.previousY,this.increaseValueY=!0),this.xDiff>10){if(this.increaseValueX)for(t=this.previousX;t<this.currentX;t+=5)this.out&&this.outXposition<fluid.width&&(this.currentX=0),this.increaseValueY&&this.previousY<this.currentY?this.previousY+=5:!this.increaseValueY&&this.previousY>this.currentY&&(this.previousY-=5),fluid.addParticle(settings.elementTypeId,t,this.previousY),this.finalX=t,this.finalY=this.previousY;else for(t=this.previousX;t>this.currentX;t-=5)this.out&&this.outXposition>fluid.width&&(this.currentX=fluid.width),this.increaseValueY&&this.previousY<this.currentY?this.previousY+=5:!this.increaseValueY&&this.previousY>this.currentY&&(this.previousY-=5),fluid.addParticle(settings.elementTypeId,t,this.previousY),this.finalX=t,this.finalY=this.previousY;this.previousX=this.finalX,this.previousY=this.finalY}else if(this.yDiff>10){if(this.increaseValueY)for(t=this.previousY;t<this.currentY;t+=5)this.out&&this.outYposition<fluid.height&&(this.currentY=0),this.increaseValueX&&this.previousX<this.currentX?this.previousX+=5:!this.increaseValueX&&this.previousX>this.currentX&&(this.previousX-=5),fluid.addParticle(settings.elementTypeId,this.previousX,t),this.finalX=this.previousX,this.finalY=t;else for(var t=this.previousY;t>this.currentY;t-=5)this.out&&this.outYposition>fluid.height&&(this.currentY=fluid.height),this.increaseValueX&&this.previousX<this.currentX?this.previousX+=5:!this.increaseValueX&&this.previousX>this.currentX&&(this.previousX-=5),fluid.addParticle(settings.elementTypeId,this.currentX,t),this.finalX=this.previousX,this.finalY=t;this.previousX=this.finalX,this.previousY=this.finalY}else this.out||(fluid.addParticle(settings.elementTypeId,this.x,this.y),this.previousX=this.x,this.previousY=this.y)};var mouse=new Mouse;mouse.init();var Particle=function(t,i,e,s,n){this.elementTypeId=t,this.x=i,this.y=e,this.px=s||i,this.py=n||e,this.vx=0,this.vy=0};Particle.prototype.first_process=function(){var t=fluid.grid[Math.round(this.y/fluid.spacing)*fluid.num_x+Math.round(this.x/fluid.spacing)];t&&(t.close[t.length++]=this),this.elementTypeId!=type.wall.id&&(this.vx=this.x-this.px,this.vy=this.y-this.py,this.vx+=settings.GRAVITY_X,this.vy+=settings.GRAVITY_Y,this.px=this.x,this.py=this.y,this.x+=this.vx,this.y+=this.vy)},Particle.prototype.second_process=function(){for(var t=0,i=0,e=Math.round(this.x/fluid.spacing),s=Math.round(this.y/fluid.spacing),n=[],r=-1;r<2;r++)for(var u=-1;u<2;u++){var o=fluid.grid[(s+u)*fluid.num_x+(e+r)];if(o&&o.length)for(var h=0,l=o.length;h<l;h++){var a=o.close[h];if(2==a.elementTypeId&&0==this.elementTypeId){var d=a.x-this.x,p=a.y-this.y;if((c=Math.sqrt(Math.pow(d,2)+Math.pow(p,2)))<fluid.spacing){m=1-c/fluid.spacing;t+=1,i+=1,a.m=m,a.dfx=d/c*m,a.dfy=p/c*m,n.push(a)}}else if(a!=this&&a.elementTypeId!=type.wall.id){var d=a.x-this.x,p=a.y-this.y,c=Math.sqrt(Math.pow(d,2)+Math.pow(p,2));if(c<fluid.spacing){var m=1-c/fluid.spacing;t+=Math.pow(m,2),i+=Math.pow(m,3)/2,a.m=m,a.dfx=d/c*m,a.dfy=p/c*m,n.push(a)}}else a!=this&&(a.elementTypeId,type.wall.id)}}t=.5*(t-3);for(var f=0,l=n.length;f<l;f++){var y=n[f],v=t+i*y.m;this.elementTypeId!=type.wall.id&&(y.elementTypeId,type.wall.id),v*=.35;var g=y.dfx*v*.5,w=y.dfy*v*.5;this.elementTypeId!=type.wall.id&&y.elementTypeId!=type.wall.id&&(y.x+=g,y.y+=w),this.elementTypeId!=type.wall.id&&y.elementTypeId==type.wall.id?(this.x-=g,this.y-=w):this.elementTypeId!=type.wall.id&&(y.elementTypeId,type.wall.id)}this.x<fluid.limit?settings.outflow?this.x<0&&fluid.destroyParticle(this):this.x=fluid.limit:this.x>fluid.width-fluid.limit&&(settings.outflow?this.x>fluid.width&&fluid.destroyParticle(this):this.x=fluid.width-fluid.limit),this.y<fluid.limit?settings.outflow?fluid.destroyParticle(this):this.y=fluid.limit:this.y>fluid.height-fluid.limit&&(settings.outflow?this.y>fluid.height&&fluid.destroyParticle(this):this.y=fluid.height-fluid.limit),this.draw()},Particle.prototype.draw=function(){var t=2*element.radius;fluid.meta_ctx.drawImage(element.textures[this.elementTypeId],this.x-element.radius,this.y-element.radius,t,t)};var Settings=function(){};Settings.prototype.init=function(){this.GRAVITY_X=0,this.GRAVITY_Y=1,this.GROUPS=[],this.elementTypeId=0,this.pauseOnDrawing=!0,this.pauseGame=!1,this.outflow=!1,this.inflow=!1};var settings=new Settings;settings.init();var Type=function(){};Type.prototype.init=function(){this.water={id:0,color:"rgba(128, 186, 247"},this.fire={id:1,color:"rgba(247, 44, 44"},this.wall={id:2,color:"rgba(229, 129, 96"}};var type=new Type;type.init();